<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Account - Smart Attendance OS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <style>
        :root {
            /* Aqtos-inspired Theme */
            --primary: #0891b2; 
            --primary-dark: #0e7490;
            --primary-light: #ecfeff;
            
            --slate-900: #0f172a; 
            --slate-600: #475569;
            --slate-400: #94a3b8;
            --slate-100: #f1f5f9; 
            
            --surface: #ffffff;
            --border: #e2e8f0;
            --danger: #ef4444;
        }

        body {
            margin: 0;
            font-family: "Inter", sans-serif;
            color: var(--slate-900);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            
            /* Tech Dot Grid Background */
            background-color: var(--slate-100);
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 32px 32px;
        }

        .signup-container {
            width: 100%;
            max-width: 600px;
        }

        /* Brand Logo (Centered) */
        .brand {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
            font-weight: 700;
            font-size: 20px;
            color: var(--slate-900);
        }

        .brand-logo { 
            width: 40px; height: 40px; 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 20px;
            box-shadow: 0 4px 6px -1px rgba(8, 145, 178, 0.2);
        }

        /* Card */
        .signup-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
        }

        .signup-header { text-align: center; margin-bottom: 32px; }
        .signup-header h1 { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--slate-900); letter-spacing: -0.5px; }
        .signup-header p { font-size: 14px; color: var(--slate-600); }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .form-group { margin-bottom: 20px; }
        .form-group.full-width { grid-column: 1 / -1; }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--slate-900);
            margin-bottom: 8px;
        }

        .form-control {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            color: var(--slate-900);
            background: var(--surface);
            transition: all 0.2s;
            font-family: inherit;
            box-sizing: border-box; /* Crucial for sizing */
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        select.form-control { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,..."); } /* Simplification */

        /* Camera Section */
        .camera-section {
            background: var(--slate-100);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px dashed var(--slate-400);
            margin-bottom: 24px;
        }

        .camera-viewport {
            width: 100%;
            max-width: 320px;
            height: 240px;
            background: #000;
            border-radius: 12px;
            margin: 0 auto 16px;
            overflow: hidden;
            position: relative;
        }

        video, #captured-preview { width: 100%; height: 100%; object-fit: cover; }
        #captured-preview { display: none; }

        /* Buttons */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: 1px solid transparent; transition: all 0.2s;
        }

        .btn-primary { background: var(--slate-900); color: white; width: 100%; padding: 14px; font-size: 14px; }
        .btn-primary:hover { background: black; transform: translateY(-1px); }

        .btn-outline { background: white; border-color: var(--border); color: var(--slate-600); }
        .btn-outline:hover { border-color: var(--slate-400); background: var(--slate-50); }

        .btn-action { background: var(--primary); color: white; }
        .btn-action:hover { background: var(--primary-dark); }

        /* Footer */
        .footer-text { margin-top: 24px; text-align: center; font-size: 14px; color: var(--slate-600); }
        .footer-text a { color: var(--primary); text-decoration: none; font-weight: 600; }
        .footer-text a:hover { text-decoration: underline; }

        /* Conditional Fields */
        #student-fields { display: none; } /* Hidden by default */
    </style>
</head>

<body>

    <div class="signup-container">
        <div class="brand">
            <div class="brand-logo"><i class="bi bi-layers-fill"></i></div>
            SmartAttendance
        </div>

        <div class="signup-card">
            <div class="signup-header">
                <h1>Create Account</h1>
                <p>Register your academic identity.</p>
            </div>

            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        {{ form.username }} 
                        </div>
                    
                    <div class="form-group">
                        <label class="form-label">Email Address</label>
                        {{ form.email }}
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">I am a...</label>
                        {{ form.user_type }}
                    </div>

                    <div id="student-fields" class="full-width form-grid" style="gap: 20px; margin: 0;">
                        <div class="form-group">
                            <label class="form-label">Roll Number</label>
                            {{ form.student_id }}
                        </div>
                        <div class="form-group">
                            <label class="form-label">Department</label>
                            {{ form.department }}
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Face Verification Photo</label>
                        <div class="camera-section">
                            <div class="camera-viewport">
                                <video id="video" autoplay playsinline></video>
                                <img id="captured-preview" alt="Captured Face">
                            </div>
                            
                            <div class="d-flex justify-content-center gap-2">
                                <button type="button" id="start-btn" class="btn btn-outline">
                                    <i class="bi bi-camera"></i> Start Camera
                                </button>
                                <button type="button" id="capture-btn" class="btn btn-action" disabled>
                                    Capture Photo
                                </button>
                                <button type="button" id="retake-btn" class="btn btn-outline" style="display:none;">
                                    Retake
                                </button>
                            </div>
                            <p style="font-size: 12px; color: var(--slate-400); margin-top: 12px;">
                                Ensure good lighting and a clear view of your face.
                            </p>
                        </div>
                        <input type="hidden" name="profile_image_data" id="profile_image_data" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Password</label>
                        {{ form.password1 }}
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        {{ form.password2 }}
                    </div>
                </div>

                <button type="submit" class="btn-primary">
                    Create Account <i class="bi bi-arrow-right-short" style="vertical-align: middle;"></i>
                </button>

                <div class="footer-text">
                    Already have an account? <a href="/login/">Sign In</a>
                </div>
            </form>
        </div>
        
        <p style="margin-top: 24px; font-size: 12px; color: var(--slate-400); text-align: center;">
            Authorized academic use only. Â© 2025 MREC
        </p>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // 1. Add 'form-control' class to all Django rendered inputs
        document.querySelectorAll('input, select').forEach(el => {
            el.classList.add('form-control');
        });

        // 2. Toggle Student Fields based on Role
        const userTypeSelect = document.querySelector('select[name="user_type"]');
        const studentFields = document.getElementById('student-fields');

        function toggleFields() {
            if (userTypeSelect.value === 'student') {
                studentFields.style.display = 'grid'; // Use grid for layout
                // Also ensure inputs inside are visible
            } else {
                studentFields.style.display = 'none';
            }
        }
        
        if (userTypeSelect) {
            userTypeSelect.addEventListener('change', toggleFields);
            toggleFields(); // Run on init
        }

        // 3. Camera Logic
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const preview = document.getElementById('captured-preview');
        const hiddenInput = document.getElementById('profile_image_data');
        const startBtn = document.getElementById('start-btn');
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        let stream = null;

        startBtn.addEventListener('click', async () => {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                video.srcObject = stream;
                startBtn.style.display = 'none';
                captureBtn.disabled = false;
            } catch (err) {
                alert("Camera access denied. Please allow permissions.");
            }
        });

        captureBtn.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg');
            hiddenInput.value = dataUrl;

            preview.src = dataUrl;
            preview.style.display = 'block';
            video.style.display = 'none';

            captureBtn.style.display = 'none';
            retakeBtn.style.display = 'inline-flex';
            
            // Optional: Stop stream to save battery
            // if(stream) stream.getTracks().forEach(t => t.stop());
        });

        retakeBtn.addEventListener('click', async () => {
            preview.style.display = 'none';
            video.style.display = 'block';
            hiddenInput.value = '';
            
            captureBtn.style.display = 'inline-flex';
            retakeBtn.style.display = 'none';
            
            // Restart stream if stopped
            if (!video.srcObject || !video.srcObject.active) {
                 try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                } catch(e) {}
            }
        });
    </script>

</body>
</html>