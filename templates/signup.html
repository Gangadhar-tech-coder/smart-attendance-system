<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Sign Up with Face ID</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* CSS for the camera circle */
        #camera-container { position: relative; width: 300px; height: 300px; margin: 0 auto; overflow: hidden; border-radius: 50%; border: 5px solid #ddd; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #captured-preview { display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        .hidden-field { display: none; }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white text-center">
                    <h4>Student Registration</h4>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label>Username</label>
                                {{ form.username }}
                            </div>
                            <div class="col-md-6">
                                <label>Email</label>
                                {{ form.email }}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label>Role</label>
                            {{ form.user_type }}
                        </div>
                        
                        <div id="student-fields" class="row mb-3">
                            <div class="col-md-6">
                                <label>Roll Number</label>
                                {{ form.student_id }}
                            </div>
                            <div class="col-md-6">
                                <label>Department</label>
                                {{ form.department }}
                            </div>
                        </div>

                        <div class="text-center mb-4 mt-4">
                            <h5 class="mb-3">Capture Profile Photo</h5>
                            <p class="text-muted small">This photo will be used for attendance.</p>
                            
                            <div id="camera-container">
                                <video id="video" autoplay playsinline></video>
                                <img id="captured-preview" src="" alt="Captured">
                            </div>
                            
                            <div class="mt-3">
                                <button type="button" id="start-btn" class="btn btn-outline-primary btn-sm">Start Camera</button>
                                <button type="button" id="capture-btn" class="btn btn-success btn-sm" disabled>Capture Photo</button>
                                <button type="button" id="retake-btn" class="btn btn-warning btn-sm d-none">Retake</button>
                            </div>

                            <input type="hidden" name="profile_image_data" id="profile_image_data" required>
                            <canvas id="canvas" style="display:none;"></canvas>
                        </div>

                        <div class="mb-3">
                            <label>Password</label>
                            {{ form.password1 }}
                        </div>
                        <div class="mb-3">
                            <label>Confirm Password</label>
                            {{ form.password2 }}
                        </div>

                        <button type="submit" class="btn btn-primary w-100 btn-lg">Complete Registration</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Camera Logic
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('captured-preview');
    const hiddenInput = document.getElementById('profile_image_data');
    
    document.getElementById('start-btn').addEventListener('click', async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            document.getElementById('capture-btn').disabled = false;
        } catch (err) {
            alert("Camera access denied!");
        }
    });

    document.getElementById('capture-btn').addEventListener('click', () => {
        // Draw video frame to canvas
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // Convert to Base64
        const dataUrl = canvas.toDataURL('image/jpeg');
        hiddenInput.value = dataUrl;
        
        // Show preview, hide video
        preview.src = dataUrl;
        preview.style.display = 'block';
        video.style.display = 'none';
        
        // Toggle buttons
        document.getElementById('retake-btn').classList.remove('d-none');
        document.getElementById('capture-btn').classList.add('d-none');
    });

    document.getElementById('retake-btn').addEventListener('click', () => {
        preview.style.display = 'none';
        video.style.display = 'block';
        hiddenInput.value = '';
        document.getElementById('retake-btn').classList.add('d-none');
        document.getElementById('capture-btn').classList.remove('d-none');
    });

    // 2. Add bootstrap classes to form fields automatically
    document.querySelectorAll('input, select').forEach(el => el.classList.add('form-control'));
</script>
</body>
</html>